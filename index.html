<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Familie Schnitzler V19 - Verbessert</title>
    <style>
        /* BASIS VARIABLEN */
        :root {
            --primary: #4f46e5;
            --primary-light: #6366f1;
            --primary-dark: #4338ca;
            --accent: #f59e0b;
            --accent-light: #fbbf24;
            --bg-color: #f8fafc;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --paper: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --success-light: #34d399;
            --danger: #ef4444;
            --danger-light: #f87171;
            --warning: #f59e0b;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --radius: 16px;
            --radius-sm: 8px;
            --radius-lg: 24px;
        }

        /* DARK MODE */
        body.dark-mode {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --bg-color: #0f172a;
            --bg-gradient: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            --paper: #1e293b;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
            --shadow-xl: 0 20px 40px -10px rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body { 
            font-family: var(--font); 
            background: var(--bg-color);
            color: var(--text); 
            margin: 0; 
            padding-bottom: 100px; 
            min-height: 100vh; 
            transition: background 0.3s ease, color 0.3s ease; 
            -webkit-tap-highlight-color: transparent;
            line-height: 1.6;
        }

        /* SYNC INDICATOR */
        #sync-status {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--paper);
            padding: 10px 16px;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        #sync-status:hover {
            transform: scale(1.02);
        }

        #sync-status.syncing {
            border-color: var(--warning);
        }

        #sync-status.synced {
            border-color: var(--success);
        }

        #sync-status.error {
            border-color: var(--danger);
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
            animation: pulse 2s infinite;
        }

        #sync-status.syncing .sync-dot {
            background: var(--warning);
        }

        #sync-status.synced .sync-dot {
            background: var(--success);
            animation: none;
        }

        #sync-status.error .sync-dot {
            background: var(--danger);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        #sync-details {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--paper);
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 12px;
            box-shadow: var(--shadow-lg);
            min-width: 250px;
            display: none;
            z-index: 1001;
        }

        #sync-status:hover #sync-details {
            display: block;
        }

        /* HINTERGRUND */
        #bg-watermark {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: -1;
            background-size: cover; 
            background-position: center; 
            opacity: 0.08; 
            pointer-events: none;
            filter: blur(2px);
        }

        /* HEADER mit Gradient */
        header { 
            background: var(--bg-gradient);
            color: white; 
            padding: 20px; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            box-shadow: var(--shadow-lg);
            position: sticky; 
            top: 0; 
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .logo-container { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            border: 3px solid rgba(255,255,255,0.3); 
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            overflow: hidden; 
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        
        .logo-container:hover {
            transform: scale(1.05);
        }
        
        .logo-img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }

        .header-text h1 {
            font-size: 1.3rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* CONTAINER & CARDS */
        .container { 
            max-width: 900px; 
            margin: 20px auto; 
            padding: 0 20px; 
        }
        
        .card { 
            background: var(--paper); 
            border-radius: var(--radius); 
            box-shadow: var(--shadow);
            padding: 24px; 
            margin-bottom: 20px; 
            border: 1px solid var(--border);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }
        
        .hidden { 
            display: none !important; 
        }

        h2 { 
            margin-top: 0; 
            color: var(--text);
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        h3 { 
            margin-top: 0; 
            color: var(--text);
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            font-size: 0.9em; 
            color: var(--text-muted);
        }

        /* INPUTS mit modernem Design */
        input, select, textarea { 
            padding: 12px 16px; 
            border: 2px solid var(--border); 
            border-radius: var(--radius-sm); 
            width: 100%; 
            box-sizing: border-box; 
            background: var(--bg-color); 
            color: var(--text); 
            font-size: 16px; 
            margin-bottom: 12px; 
            outline: none;
            transition: all 0.2s ease;
            font-family: var(--font);
        }
        
        input:focus, select:focus, textarea:focus { 
            border-color: var(--primary);
            background: var(--paper);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* BUTTONS mit modernem Design */
        button { 
            background: var(--primary);
            color: white; 
            border: none; 
            padding: 14px 24px; 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            font-size: 1rem; 
            width: 100%; 
            font-weight: 600; 
            margin-top: 8px; 
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
            font-family: var(--font);
        }
        
        button:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        button:active { 
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }
        
        button.secondary { 
            background: var(--text-muted);
            width: auto; 
            padding: 10px 20px; 
            font-size: 0.9rem; 
            margin: 5px 5px 5px 0; 
            display: inline-block;
        }

        button.secondary:hover {
            background: var(--text);
        }
        
        button.del-btn { 
            background: var(--danger);
            width: auto; 
            padding: 6px 12px; 
            font-size: 0.85rem; 
            margin: 0;
        }

        button.del-btn:hover {
            background: var(--danger-light);
        }
        
        /* TABS mit modernem Design */
        .tabs { 
            display: flex; 
            gap: 0;
            overflow-x: auto; 
            padding: 0;
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            background: var(--paper);
            backdrop-filter: blur(20px);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            z-index: 90; 
            justify-content: space-around;
            border-top: 1px solid var(--border);
        }
        
        .tab-btn { 
            background: transparent; 
            color: var(--text-muted);
            border: none; 
            padding: 12px 8px;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-size: 0.7rem; 
            opacity: 0.7;
            width: auto; 
            margin: 0;
            transition: all 0.2s ease;
            position: relative;
            flex: 1;
            border-radius: 0;
            box-shadow: none;
        }
        
        .tab-btn span { 
            font-size: 1.5rem; 
            margin-bottom: 4px;
            transition: transform 0.2s ease;
        }
        
        .tab-btn.active { 
            color: var(--primary);
            opacity: 1; 
            font-weight: 700;
            background: transparent;
        }

        .tab-btn.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            border-radius: 0 0 3px 3px;
        }

        .tab-btn.active span {
            transform: scale(1.1);
        }

        .tab-btn:hover {
            background: transparent;
            transform: none;
        }

        /* TASKS mit modernem Design */
        .task-item { 
            display: flex; 
            align-items: center; 
            padding: 16px; 
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: var(--radius-sm);
            margin-bottom: 4px;
        }

        .task-item:hover {
            background: var(--bg-color);
        }
        
        .task-item.done { 
            opacity: 0.5; 
            text-decoration: line-through; 
        }
        
        .checkbox { 
            width: 28px; 
            height: 28px; 
            border: 2.5px solid var(--border); 
            border-radius: 8px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-right: 16px; 
            flex-shrink: 0;
            color: white; 
            font-weight: bold; 
            font-size: 16px;
            transition: all 0.2s ease;
        }
        
        .checkbox.checked { 
            background: var(--success);
            border-color: var(--success);
            transform: scale(1.05);
        }

        /* LOGIN GRID mit Cards */
        .login-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 16px; 
            margin-top: 24px; 
        }
        
        .user-card { 
            background: var(--paper);
            border: 2px solid var(--border); 
            padding: 20px; 
            text-align: center; 
            border-radius: var(--radius); 
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }
        
        .user-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }
        
        .user-card:active { 
            transform: translateY(-2px);
        }
        
        .user-avatar-img { 
            width: 75px; 
            height: 75px; 
            border-radius: 50%; 
            object-fit: cover; 
            margin-bottom: 12px; 
            border: 3px solid var(--primary);
            box-shadow: var(--shadow);
        }

        /* SCHEDULE GRID */
        .schedule-grid { 
            display: grid; 
            grid-template-columns: 50px 1fr 1fr; 
            gap: 8px; 
            align-items: center; 
            margin-bottom: 8px;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: background 0.2s ease;
        }
        
        .schedule-grid:hover {
            background: var(--bg-color);
        }
        
        .schedule-grid label { 
            margin: 0; 
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .schedule-grid input { 
            margin: 0; 
            padding: 10px; 
            font-size: 0.9rem; 
        }
        
        .weekend-row { 
            background: rgba(245, 158, 11, 0.1);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--accent);
        }

        /* THEME & SWITCH */
        .color-options { 
            display: flex; 
            gap: 12px; 
            margin-bottom: 20px; 
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .color-circle { 
            width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            cursor: pointer; 
            border: 3px solid transparent;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .color-circle:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow);
        }

        .color-circle.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2);
        }
        
        .switch-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 16px 0; 
            border-bottom: 1px solid var(--border);
        }
        
        .toggle-switch { 
            position: relative; 
            display: inline-block; 
            width: 56px; 
            height: 30px; 
        }
        
        .toggle-switch input { 
            opacity: 0; 
            width: 0; 
            height: 0; 
        }
        
        .slider { 
            position: absolute; 
            cursor: pointer; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: var(--border);
            transition: .3s; 
            border-radius: 34px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .slider:before { 
            position: absolute; 
            content: ""; 
            height: 24px; 
            width: 24px; 
            left: 3px; 
            bottom: 3px; 
            background-color: white;
            transition: .3s; 
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        input:checked + .slider { 
            background-color: var(--primary);
        }
        
        input:checked + .slider:before { 
            transform: translateX(26px); 
        }

        /* Zus√§tzliche Design-Verbesserungen */
        .plan-row {
            padding: 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            transition: background 0.2s ease;
        }

        .plan-row:hover {
            background: var(--bg-color);
        }

        .plan-inputs {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 8px;
        }

        .plan-inputs input {
            margin: 0;
        }

        /* Info-Boxen */
        .info-box {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.1) 0%, rgba(99, 102, 241, 0.05) 100%);
            border-left: 4px solid var(--primary);
            padding: 16px;
            border-radius: var(--radius-sm);
            margin: 16px 0;
            font-size: 0.9rem;
        }

        .warning-box {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(251, 191, 36, 0.05) 100%);
            border-left: 4px solid var(--warning);
            padding: 16px;
            border-radius: var(--radius-sm);
            margin: 16px 0;
            font-size: 0.9rem;
            color: var(--text);
        }

        .success-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(52, 211, 153, 0.05) 100%);
            border-left: 4px solid var(--success);
            padding: 16px;
            border-radius: var(--radius-sm);
            margin: 16px 0;
            font-size: 0.9rem;
        }

        /* Statistik-Karten */
        .stat-card {
            background: var(--bg-color);
            border-radius: var(--radius-sm);
            padding: 16px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Responsive Anpassungen */
        @media (max-width: 600px) {
            .container {
                padding: 0 12px;
            }

            .card {
                padding: 20px;
                border-radius: 12px;
            }

            h2 {
                font-size: 1.5rem;
            }

            .login-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 12px;
            }

            #sync-status {
                top: 70px;
                right: 10px;
                font-size: 0.75rem;
                padding: 8px 12px;
            }
        }

        /* Animationen */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            animation: fadeIn 0.3s ease;
        }

        /* Scroll-Verhalten */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

    </style>
</head>
<body>

<div id="bg-watermark"></div>

<!-- Sync Status Indicator -->
<div id="sync-status" class="error" onclick="app.showSyncInfo()">
    <div class="sync-dot"></div>
    <span id="sync-text">Offline</span>
    <div id="sync-details">
        <strong>Sync-Status</strong><br>
        <small id="sync-last">Noch nie synchronisiert</small><br>
        <small id="sync-gist">Kein Gist</small>
    </div>
</div>

<header>
    <div style="display:flex; align-items:center; gap:12px; flex:1;">
        <div class="logo-container"><img id="logo-img" class="logo-img" src="https://cdn-icons-png.flaticon.com/512/3655/3655589.png"></div>
        <div class="header-text">
            <h1>Schnitzler Family App</h1>
        </div>
    </div>
</header>

<div id="view-login" class="container">
    <div class="card">
        <h2 style="text-align:center">üëã Wer bist du?</h2>
        <p style="text-align:center; color:var(--text-muted); margin-bottom:20px;">W√§hle dein Profil aus</p>
        <div class="login-grid" id="login-users"></div>
        <div style="margin-top:30px; text-align:center;">
            <button class="secondary" onclick="app.checkPinAndSetup()">‚öôÔ∏è Admin-Einstellungen</button>
        </div>
    </div>
</div>

<div id="view-setup" class="container hidden">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0;">‚öôÔ∏è Administrator</h2>
            <button class="secondary" style="margin:0;" onclick="app.showLogin()">üö™ Abmelden</button>
        </div>
        
        <div style="margin:20px 0; padding-bottom:20px; border-bottom:2px dashed var(--border);">
            <h3>‚òÅÔ∏è Cloud-Synchronisation</h3>
            <div id="sync-info-box" class="warning-box">
                <strong id="sync-status-text">Status: Nicht konfiguriert</strong><br>
                <span id="sync-details-text">Konfiguriere GitHub Token f√ºr automatische Synchronisation</span>
            </div>
            
            <label>GitHub Personal Access Token</label>
            <input type="password" id="github-token" placeholder="ghp_..." value="">
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <button onclick="app.saveGitHubToken()">üíæ Token speichern</button>
                <button class="secondary" onclick="app.testConnection()" style="width:100%; margin:0;">üîç Verbindung testen</button>
            </div>
            
            <div style="margin-top:10px;">
                <button class="secondary" onclick="app.manualSync()">üîÑ Jetzt synchronisieren</button>
                <button class="secondary" onclick="app.loadFromCloud()">üì• Von Cloud laden</button>
                <button class="secondary" onclick="app.forceUpload()">üì§ Upload erzwingen</button>
            </div>
            
            <div class="info-box" style="margin-top:15px;">
                <strong>üí° So funktioniert's:</strong><br>
                1. Erstelle einen GitHub Token (siehe Anleitung)<br>
                2. F√ºge den Token hier ein und klicke "Token speichern"<br>
                3. Die App synchronisiert automatisch alle 30 Sekunden<br>
                4. Alle Ger√§te mit dem gleichen Token werden synchronisiert
            </div>
            
            <div class="warning-box" style="margin-top:10px;">
                <strong>‚ö†Ô∏è Token erstellen:</strong><br>
                1. github.com ‚Üí Settings ‚Üí Developer settings<br>
                2. Personal access tokens ‚Üí Tokens (classic)<br>
                3. Generate new token (classic)<br>
                4. Aktiviere nur "gist"<br>
                5. Token kopieren und hier einf√ºgen
            </div>
        </div>

        <div style="margin:20px 0; padding-bottom:20px; border-bottom:2px dashed var(--border);">
            <h3>üé® Design & Sicherheit</h3>
            <div class="warning-box">
                <strong>‚ö†Ô∏è Hinweis:</strong> Bitte nur kleine Bilder verwenden!
            </div>
            <button class="secondary" onclick="document.getElementById('logo-up').click()">üñºÔ∏è Logo √§ndern</button>
            <input type="file" id="logo-up" hidden accept="image/*" onchange="app.uploadImage('logo', this)">
            
            <button class="secondary" onclick="document.getElementById('bg-up').click()">üåä Hintergrund √§ndern</button>
            <input type="file" id="bg-up" hidden accept="image/*" onchange="app.uploadImage('bg', this)">
            
            <button class="secondary" onclick="app.changePin()">üîë Admin-PIN √§ndern</button>
        </div>

        <div style="margin:20px 0; padding-bottom:20px; border-bottom:2px dashed var(--border);">
            <h3>üé® Farbschema</h3>
            <div class="color-options">
                <div class="color-circle" style="background:#e67e22" onclick="app.setColor('#e67e22')"></div>
                <div class="color-circle" style="background:#3498db" onclick="app.setColor('#3498db')"></div>
                <div class="color-circle" style="background:#9b59b6" onclick="app.setColor('#9b59b6')"></div>
                <div class="color-circle" style="background:#e74c3c" onclick="app.setColor('#e74c3c')"></div>
                <div class="color-circle" style="background:#1abc9c" onclick="app.setColor('#1abc9c')"></div>
                <div class="color-circle" style="background:#f39c12" onclick="app.setColor('#f39c12')"></div>
            </div>
            <div class="switch-row">
                <span style="font-weight:600;">üåô Dark Mode</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="dark-toggle" onchange="app.toggleDark()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div id="setup-kids"></div>
        <button onclick="app.saveSetup()">üíæ Konfiguration speichern</button>
    </div>
</div>

<div id="view-child" class="container hidden">
    <div class="card">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:20px;">
            <img id="c-avatar" style="width:60px; height:60px; border-radius:50%; border:3px solid var(--primary); box-shadow:var(--shadow);">
            <div>
                <h2 id="c-name" style="margin:0;">Kind</h2>
                <p id="c-free" style="color:var(--text-muted); margin:0; font-size:0.9rem;"></p>
            </div>
            <button class="secondary" style="margin-left:auto;" onclick="app.showLogin()">üö™ Abmelden</button>
        </div>
    </div>

    <div id="child-tasks" class="hidden">
        <div class="card">
            <h3>‚úÖ Deine Aufgaben heute</h3>
            <div id="c-task-list"></div>
            <button id="finish-btn" onclick="app.finishDay()" style="margin-top:15px;">üéâ Tag abschlie√üen</button>
            <div id="preview-box" class="hidden info-box" style="margin-top:15px;">
                <h4 style="margin-top:0; color:var(--primary);">üìã Morgen wartet auf dich:</h4>
                <ul id="preview-list" style="margin:0; padding-left:20px;"></ul>
            </div>
        </div>
    </div>

    <div id="child-finance" class="hidden">
        <div class="card">
            <h3>üí∞ Dein Guthaben</h3>
            <div class="stat-card" style="margin:20px 0;">
                <div class="stat-value" id="c-bal">0.00 ‚Ç¨</div>
                <div class="stat-label">Aktuelles Guthaben</div>
            </div>
            <div class="info-box">
                <p id="c-proj" style="margin:0; font-weight:600;"></p>
            </div>
        </div>
    </div>

    <div id="child-plan" class="hidden">
        <div class="card">
            <h3>üìÖ Wochenplan</h3>
            <p style="color:var(--text-muted); margin-bottom:20px;">Trage deine Termine und Hobbys ein</p>
            <div id="hobby-container"></div>
            <button onclick="app.saveHobbies()" style="margin-top:15px;">üíæ Plan speichern</button>
        </div>
    </div>

    <div id="child-profile" class="hidden">
        <div class="card">
            <h3>üë§ Profil-Einstellungen</h3>
            <label>Spitzname</label>
            <input id="p-nick" placeholder="Dein Spitzname">
            <label>Avatar-Bild √§ndern</label>
            <button class="secondary" onclick="document.getElementById('av-up').click()">üì∏ Neues Bild hochladen</button>
            <input type="file" id="av-up" hidden accept="image/*" onchange="app.uploadImage('av'+app.user,this)">
            <label style="margin-top:15px;">Passwort (optional)</label>
            <input type="password" id="p-pass" placeholder="Neues Passwort">
            <button onclick="app.saveProfileData()" style="margin-top:15px;">üíæ Profil speichern</button>
        </div>
    </div>

    <div id="child-msg" class="hidden">
        <div class="card">
            <h3>üí¨ Nachricht an Eltern</h3>
            <textarea id="msg-text" rows="4" placeholder="Deine Nachricht..."></textarea>
            <button onclick="app.sendMsg()">üì§ Nachricht senden</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn" onclick="app.nav('tasks',this)"><span>‚úÖ</span>Aufgaben</button>
        <button class="tab-btn" onclick="app.nav('finance',this)"><span>üí∞</span>Guthaben</button>
        <button class="tab-btn" onclick="app.nav('plan',this)"><span>üìÖ</span>Plan</button>
        <button class="tab-btn" onclick="app.nav('profile',this)"><span>üë§</span>Profil</button>
        <button class="tab-btn" onclick="app.nav('msg',this)"><span>üí¨</span>Nachricht</button>
    </div>
</div>

<div id="view-parent" class="container hidden">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Eltern-√úbersicht</h2>
            <button class="secondary" style="margin:0;" onclick="app.showLogin()">üö™ Abmelden</button>
        </div>
        
        <h3>üì¨ Nachrichten von Kindern</h3>
        <div id="parent-inbox" style="margin-bottom:30px; min-height:50px;"></div>
        
        <h3 style="margin-top:30px;">üë∂ Kinder-Status</h3>
        <div id="parent-grid"></div>
        
        <div style="margin-top:30px; padding-top:20px; border-top:2px dashed var(--border);">
            <h3>üìä Datenverwaltung</h3>
            <button class="secondary" onclick="app.exportData()">üì• Backup herunterladen</button>
            <button class="secondary" onclick="app.manualSync()">üîÑ Jetzt synchronisieren</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
const DAYS = ["Mo","Di","Mi","Do","Fr","Sa","So"];
const DEFAULT = {
    pin: "1234",
    color: "#4f46e5",
    darkMode: false,
    logo: "",
    bg: "",
    kids: [],
    msgs: [],
    lastModified: Date.now()
};

const app = {
    data: null,
    user: null,
    githubToken: null,
    gistId: null,
    autoSyncInterval: null,
    lastSyncTime: 0,
    isSyncing: false,

    init: function() {
        console.log('üöÄ App initialisiert');
        
        // Lokale Daten laden
        const raw = localStorage.getItem("familyData");
        this.data = raw ? JSON.parse(raw) : JSON.parse(JSON.stringify(DEFAULT));
        if(!this.data.kids) this.data.kids = [];
        if(!this.data.msgs) this.data.msgs = [];
        if(!this.data.lastModified) this.data.lastModified = Date.now();
        
        // GitHub Config laden
        this.githubToken = localStorage.getItem('githubToken');
        this.gistId = localStorage.getItem('gistId');
        
        console.log('Token vorhanden:', !!this.githubToken);
        console.log('Gist ID:', this.gistId);
        
        // Design laden
        if(this.data.logo) document.getElementById('logo-img').src = this.data.logo;
        if(this.data.bg) document.getElementById('bg-watermark').style.backgroundImage = `url(${this.data.bg})`;
        if(this.data.color) this.setColor(this.data.color);
        if(this.data.darkMode) { document.body.classList.add('dark-mode'); document.getElementById('dark-toggle').checked=true; }
        
        // Sync starten
        if(this.githubToken) {
            console.log('‚úÖ Token gefunden - starte Auto-Sync');
            this.setSyncStatus('syncing', 'Verbinde...');
            this.startAutoSync();
            // Initial laden
            setTimeout(() => this.loadFromCloud(), 1000);
        } else {
            console.log('‚ùå Kein Token - Offline-Modus');
            this.setSyncStatus('error', 'Offline-Modus');
        }
        
        this.showLogin();
    },

    setSyncStatus: function(status, text) {
        const statusEl = document.getElementById('sync-status');
        const textEl = document.getElementById('sync-text');
        
        statusEl.className = status;
        textEl.textContent = text;
        
        // Sync-Details aktualisieren
        const lastEl = document.getElementById('sync-last');
        if(this.lastSyncTime > 0) {
            const ago = Math.round((Date.now() - this.lastSyncTime) / 1000);
            lastEl.textContent = `Zuletzt: vor ${ago}s`;
        }
        
        const gistEl = document.getElementById('sync-gist');
        if(this.gistId) {
            gistEl.textContent = `Gist: ${this.gistId.substring(0, 8)}...`;
        }
    },

    showSyncInfo: function() {
        const info = `
üìä Sync-Status-Info:

Token: ${this.githubToken ? '‚úÖ Konfiguriert' : '‚ùå Fehlt'}
Gist ID: ${this.gistId || 'Nicht erstellt'}
Letzte Sync: ${this.lastSyncTime > 0 ? new Date(this.lastSyncTime).toLocaleTimeString() : 'Noch nie'}
Auto-Sync: ${this.autoSyncInterval ? '‚úÖ Aktiv (alle 30s)' : '‚ùå Inaktiv'}

${!this.githubToken ? '\n‚ö†Ô∏è Bitte GitHub Token in Admin-Einstellungen konfigurieren!' : ''}
${this.githubToken && !this.gistId ? '\n‚ö†Ô∏è Klicke auf "Jetzt synchronisieren" um Gist zu erstellen!' : ''}
        `.trim();
        
        alert(info);
    },

    async testConnection() {
        const token = document.getElementById('github-token').value.trim();
        if(!token) {
            alert('‚ùå Bitte Token eingeben!');
            return;
        }
        
        this.setSyncStatus('syncing', 'Teste...');
        
        try {
            const response = await fetch('https://api.github.com/user', {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if(response.ok) {
                const user = await response.json();
                this.setSyncStatus('synced', 'Verbunden');
                alert(`‚úÖ Verbindung erfolgreich!\n\nGitHub-Nutzer: ${user.login}\nToken ist g√ºltig!`);
            } else {
                this.setSyncStatus('error', 'Token ung√ºltig');
                alert('‚ùå Token ist ung√ºltig!\nBitte √ºberpr√ºfe den Token.');
            }
        } catch(error) {
            console.error('Test Error:', error);
            this.setSyncStatus('error', 'Verbindungsfehler');
            alert('‚ùå Verbindungsfehler!\nBitte Internetverbindung pr√ºfen.');
        }
    },

    saveGitHubToken: function() {
        const token = document.getElementById('github-token').value.trim();
        if(!token) {
            alert('‚ùå Bitte gib ein GitHub Token ein!');
            return;
        }
        
        if(!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
            if(!confirm('‚ö†Ô∏è Das sieht nicht nach einem g√ºltigen GitHub Token aus.\n\nTrotzdem speichern?')) {
                return;
            }
        }
        
        this.githubToken = token;
        localStorage.setItem('githubToken', token);
        
        console.log('üíæ Token gespeichert');
        
        this.setSyncStatus('syncing', 'Token gespeichert...');
        
        // Initial sync
        this.forceUpload().then(() => {
            this.startAutoSync();
            document.getElementById('sync-status-text').textContent = 'Status: ‚úÖ Aktiv';
            document.getElementById('sync-details-text').textContent = 'Auto-Sync alle 30 Sekunden';
            document.getElementById('sync-info-box').className = 'success-box';
            alert('‚úÖ GitHub Token gespeichert und getestet!\n\nCloud-Sync ist jetzt aktiv.\nDeine Daten werden automatisch alle 30 Sekunden synchronisiert.');
        }).catch(err => {
            console.error('Initial Sync Error:', err);
            this.setSyncStatus('error', 'Sync-Fehler');
            alert('‚ùå Token konnte nicht validiert werden.\n\nFehler: ' + err.message + '\n\nBitte Token √ºberpr√ºfen.');
        });
    },

    startAutoSync: function() {
        console.log('‚ñ∂Ô∏è Starte Auto-Sync');
        
        if(this.autoSyncInterval) {
            clearInterval(this.autoSyncInterval);
        }
        
        // Alle 30 Sekunden synchronisieren
        this.autoSyncInterval = setInterval(() => {
            if(this.githubToken && !this.isSyncing) {
                console.log('üîÑ Auto-Sync l√§uft...');
                this.syncWithCloud();
            }
        }, 30000); // 30 Sekunden
        
        console.log('‚úÖ Auto-Sync aktiv (alle 30s)');
    },

    async syncWithCloud() {
        if(this.isSyncing) {
            console.log('‚è≠Ô∏è Sync l√§uft bereits, √ºberspringe...');
            return;
        }
        
        this.isSyncing = true;
        console.log('üîÑ Starte Sync-Zyklus');
        
        try {
            // Erst laden
            await this.loadFromCloud();
            // Dann speichern
            await this.saveToCloud();
        } catch(error) {
            console.error('Sync Cycle Error:', error);
        } finally {
            this.isSyncing = false;
        }
    },

    async forceUpload() {
        console.log('üì§ Erzwinge Upload...');
        this.data.lastModified = Date.now();
        await this.saveToCloud();
    },

    async saveToCloud() {
        if(!this.githubToken) {
            console.log('‚ö†Ô∏è Kein Token - Skip Save');
            return;
        }
        
        console.log('üíæ Speichere in Cloud...');
        this.setSyncStatus('syncing', 'Speichere...');
        
        const gistData = {
            description: 'Schnitzler Family App Data - ' + new Date().toLocaleString(),
            public: false,
            files: {
                'family-data.json': {
                    content: JSON.stringify(this.data, null, 2)
                },
                'README.md': {
                    content: `# Schnitzler Family App\n\nLetzte Aktualisierung: ${new Date().toLocaleString()}\n\nDies ist ein automatisches Backup der Family App.`
                }
            }
        };
        
        try {
            let response;
            const headers = {
                'Authorization': `token ${this.githubToken}`,
                'Content-Type': 'application/json',
                'Accept': 'application/vnd.github.v3+json'
            };
            
            if(this.gistId) {
                console.log('üìù Aktualisiere existierenden Gist:', this.gistId);
                response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
                    method: 'PATCH',
                    headers: headers,
                    body: JSON.stringify(gistData)
                });
            } else {
                console.log('üÜï Erstelle neuen Gist');
                response = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(gistData)
                });
            }
            
            if(!response.ok) {
                const errorText = await response.text();
                throw new Error(`GitHub API Error ${response.status}: ${errorText}`);
            }
            
            const result = await response.json();
            
            if(!this.gistId) {
                this.gistId = result.id;
                localStorage.setItem('gistId', result.id);
                console.log('‚úÖ Neuer Gist erstellt:', result.id);
            }
            
            this.lastSyncTime = Date.now();
            this.setSyncStatus('synced', 'Gespeichert');
            console.log('‚úÖ Cloud-Save erfolgreich');
            
        } catch(error) {
            console.error('‚ùå Cloud Save Error:', error);
            this.setSyncStatus('error', 'Speicherfehler');
            throw error;
        }
    },

    async loadFromCloud() {
        if(!this.githubToken || !this.gistId) {
            console.log('‚ö†Ô∏è Kein Token/Gist - Skip Load');
            return;
        }
        
        console.log('üì• Lade von Cloud...');
        this.setSyncStatus('syncing', 'Lade...');
        
        try {
            const response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
                headers: {
                    'Authorization': `token ${this.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if(!response.ok) {
                throw new Error(`GitHub API Error: ${response.status}`);
            }
            
            const gist = await response.json();
            const content = gist.files['family-data.json'].content;
            const cloudData = JSON.parse(content);
            
            console.log('üìä Cloud-Daten geladen');
            console.log('Cloud lastModified:', cloudData.lastModified);
            console.log('Local lastModified:', this.data.lastModified);
            
            // Vergleiche Timestamps
            if(cloudData.lastModified > this.data.lastModified) {
                console.log('‚òÅÔ∏è Cloud ist neuer - √ºbernehme Cloud-Daten');
                this.data = cloudData;
                this.save(false); // Lokal speichern ohne Cloud-Upload
                this.setSyncStatus('synced', 'Aktualisiert');
                
                // UI aktualisieren
                if(this.user !== null) {
                    this.renderChild(this.user);
                }
            } else {
                console.log('üíª Lokale Daten sind aktueller');
                this.setSyncStatus('synced', 'Aktuell');
            }
            
            this.lastSyncTime = Date.now();
            
        } catch(error) {
            console.error('‚ùå Cloud Load Error:', error);
            this.setSyncStatus('error', 'Ladefehler');
        }
    },

    manualSync: function() {
        if(!this.githubToken) {
            alert('‚ö†Ô∏è Bitte zuerst GitHub Token in den Admin-Einstellungen konfigurieren!');
            return;
        }
        
        console.log('üîÑ Manueller Sync gestartet');
        this.syncWithCloud().then(() => {
            alert('‚úÖ Synchronisierung abgeschlossen!');
        }).catch((error) => {
            alert('‚ùå Synchronisierung fehlgeschlagen.\n\nFehler: ' + error.message);
        });
    },

    save: function(toCloud = true) {
        // Timestamp aktualisieren
        this.data.lastModified = Date.now();
        
        // Lokal speichern
        localStorage.setItem("familyData", JSON.stringify(this.data));
        console.log('üíæ Lokal gespeichert (lastModified:', this.data.lastModified, ')');
        
        // Cloud speichern wenn aktiviert
        if(toCloud && this.githubToken) {
            this.saveToCloud().catch(err => {
                console.error('Auto-Save Error:', err);
            });
        }
    },

    uploadImage: function(typ, inp) {
        const file = inp.files[0];
        if(!file) return;
        
        if(file.size > 500000) {
            alert('‚ùå Bild zu gro√ü! Bitte unter 500KB.');
            return;
        }
        
        const r = new FileReader();
        r.onload = e => {
            const b64 = e.target.result;
            if(typ==='logo') { 
                this.data.logo=b64; 
                document.getElementById('logo-img').src=b64; 
            }
            else if(typ==='bg') { 
                this.data.bg=b64; 
                document.getElementById('bg-watermark').style.backgroundImage=`url(${b64})`; 
            }
            else if(typ.startsWith('av')) {
                const idx = parseInt(typ.slice(2));
                this.data.kids[idx].avatar = b64;
                if(this.user===idx) document.getElementById('c-avatar').src = b64;
            }
            this.save();
        };
        r.readAsDataURL(file);
    },

    setColor: function(col) {
        this.data.color = col;
        document.documentElement.style.setProperty('--accent', col);
        document.documentElement.style.setProperty('--primary', col);
        this.save();
    },

    toggleDark: function() {
        this.data.darkMode = !this.data.darkMode;
        document.body.classList.toggle('dark-mode');
        this.save();
    },

    hideAll: function() {
        document.querySelectorAll('.container').forEach(v=>v.classList.add('hidden'));
    },

    showLogin: function() {
        this.hideAll(); 
        document.getElementById('view-login').classList.remove('hidden');
        const grid = document.getElementById('login-users');
        grid.innerHTML = "";
        
        this.data.kids.forEach((k,i) => {
            if(!k.name) return;
            const av = k.avatar || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
            grid.innerHTML += `<div class="user-card" onclick="app.tryLogin(${i},false)">
                <img class="user-avatar-img" src="${av}"><br><b>${k.nick||k.name}</b>
            </div>`;
        });
        
        grid.innerHTML += `<div class="user-card" onclick="app.tryLogin(-1,true)">
            <img class="user-avatar-img" src="https://cdn-icons-png.flaticon.com/512/747/747376.png"><br><b>Eltern</b>
        </div>`;
    },

    tryLogin: function(idx, isParent) {
        const k = this.data.kids[idx];
        if(!isParent && k && k.pass) {
            const p = prompt("Passwort:");
            if(p !== k.pass) { alert("Falsches Passwort!"); return; }
        }
        if(isParent) {
            const p = prompt("Eltern-PIN:");
            if(p !== this.data.pin) { alert("Falsche PIN!"); return; }
            this.renderParent();
        } else {
            this.user = idx;
            this.renderChild(idx);
        }
    },

    checkPinAndSetup: function() {
        const p = prompt("Admin-PIN:");
        if(p !== this.data.pin) { alert("Falsche PIN!"); return; }
        this.renderSetup();
    },

    renderSetup: function() {
        this.hideAll();
        document.getElementById('view-setup').classList.remove('hidden');
        if(this.data.darkMode) document.getElementById('dark-toggle').checked = true;
        
        // GitHub Token anzeigen
        if(this.githubToken) {
            document.getElementById('github-token').value = this.githubToken;
            document.getElementById('sync-status-text').textContent = 'Status: ‚úÖ Aktiv';
            document.getElementById('sync-details-text').textContent = `Auto-Sync alle 30 Sekunden | Gist: ${this.gistId ? this.gistId.substring(0,12)+'...' : 'Wird erstellt'}`;
            document.getElementById('sync-info-box').className = 'success-box';
        }
        
        const cnt = document.getElementById('setup-kids');
        cnt.innerHTML = "";
        
        for(let i=0; i<4; i++) {
            if(!this.data.kids[i]) {
                this.data.kids[i] = {
                    name:"", age:"", allowance:0, balance:0, avatar:"", pass:"", nick:"",
                    tasksToday:[], tasksTomorrow:[], lastFinished:"",
                    schedule: {}
                };
                DAYS.forEach(d => this.data.kids[i].schedule[d] = {sStart:"08:00",sEnd:"16:00",hName:"",hStart:"",hEnd:""});
            }
            const k = this.data.kids[i];
            
            cnt.innerHTML += `
            <div class="card" style="margin-bottom:20px;">
                <h3>üë∂ Kind ${i+1}</h3>
                <label>Name</label>
                <input id="n-${i}" value="${k.name||''}" placeholder="Name des Kindes">
                <label>Alter</label>
                <input id="a-${i}" value="${k.age||''}" placeholder="z.B. 8">
                <label>Taschengeld pro Monat (‚Ç¨)</label>
                <input type="number" step="0.01" id="m-${i}" value="${k.allowance||0}">
                
                <h4 style="margin-top:20px;">üìö Schulzeiten (Mo-So)</h4>
                <div id="schedule-${i}"></div>
                
                <button class="secondary" onclick="document.getElementById('av-up-${i}').click()">üì∏ Avatar hochladen</button>
                <input type="file" id="av-up-${i}" hidden accept="image/*" onchange="app.uploadImage('av${i}',this)">
            </div>`;
        }
        
        this.data.kids.forEach((k,i) => {
            const sch = document.getElementById(`schedule-${i}`);
            DAYS.forEach(d => {
                const s = k.schedule[d];
                const isWE = (d==="Sa"||d==="So");
                sch.innerHTML += `<div class="schedule-grid ${isWE?'weekend-row':''}">
                    <label style="font-weight:${isWE?'700':'600'}">${d}</label>
                    <input type="time" id="ss-${i}-${d}" value="${s.sStart}">
                    <input type="time" id="se-${i}-${d}" value="${s.sEnd}">
                </div>`;
            });
        });
    },

    saveSetup: function() {
        this.data.kids.forEach((k,i)=>{
            k.name = document.getElementById(`n-${i}`).value;
            k.age = document.getElementById(`a-${i}`).value;
            k.allowance = parseFloat(document.getElementById(`m-${i}`).value)||0;
            
            DAYS.forEach(d => {
                k.schedule[d].sStart = document.getElementById(`ss-${i}-${d}`).value;
                k.schedule[d].sEnd = document.getElementById(`se-${i}-${d}`).value;
            });
        });
        this.save();
        alert("‚úÖ Konfiguration erfolgreich gespeichert!");
        this.showLogin();
    },

    changePin: function() { 
        const p=prompt("Neuer Admin-PIN:"); 
        if(p){
            this.data.pin=p;
            this.save();
            alert("‚úÖ PIN wurde ge√§ndert!");
        } 
    },

    renderChild: function(idx) {
        this.hideAll();
        document.getElementById('view-child').classList.remove('hidden');
        this.nav('tasks', document.querySelectorAll('.tab-btn')[0]); 
        
        const k = this.data.kids[idx];
        document.getElementById('c-name').innerText = k.nick || k.name || `Kind ${idx+1}`;
        document.getElementById('c-avatar').src = k.avatar || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
        
        const free = this.getFreeTime(k);
        document.getElementById('c-free').innerText = `‚è±Ô∏è Freizeit heute: ca. ${free.toFixed(1)} Std.`;

        const list = document.getElementById('c-task-list');
        list.innerHTML = "";
        
        if(!k.tasksToday.length) { 
            this.generateTasks(k, 'tasksToday'); 
            this.save(); 
        }
        
        k.tasksToday.forEach(t => {
            list.innerHTML += `<div class="task-item ${t.done?'done':''}" onclick="app.childToggle(${t.id})">
                <div class="checkbox ${t.done?'checked':''}">${t.done?'‚úì':''}</div><span>${t.text}</span>
            </div>`;
        });
        
        const isDone = k.lastFinished === new Date().toDateString();
        document.getElementById('finish-btn').style.display = isDone ? 'none' : 'block';
        
        if(isDone) {
            document.getElementById('preview-box').classList.remove('hidden');
            if(!k.tasksTomorrow.length) { this.generateTasks(k, 'tasksTomorrow'); this.save(); }
            document.getElementById('preview-list').innerHTML = k.tasksTomorrow.map(t=>`<li>${t.text}</li>`).join('');
        } else {
            document.getElementById('preview-box').classList.add('hidden');
        }

        document.getElementById('c-bal').innerText = k.balance.toFixed(2)+" ‚Ç¨";
        document.getElementById('c-proj').innerText = "üìä W√∂chentlich: " + ((k.allowance/30)*7).toFixed(2) + " ‚Ç¨";

        const hc = document.getElementById('hobby-container');
        hc.innerHTML = "";
        DAYS.forEach(d => {
            const s = k.schedule[d];
            const isWE = (d==="Sa"||d==="So");
            const label = isWE ? `<b>${d} (Wochenende)</b>` : d;
            hc.innerHTML += `
            <div class="plan-row ${isWE?'weekend-row':''}">
                <label>${label}</label>
                <div class="plan-inputs">
                    <input id="h-n-${d}" value="${s.hName||''}" placeholder="Termin/Hobby">
                    <input type="time" id="h-s-${d}" value="${s.hStart}">
                    <input type="time" id="h-e-${d}" value="${s.hEnd}">
                </div>
            </div>`;
        });

        document.getElementById('p-nick').value = k.nick || k.name;
    },

    nav: function(section, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        ['tasks','finance','plan','profile','msg'].forEach(s => {
            document.getElementById('child-'+s).classList.add('hidden');
        });
        document.getElementById('child-'+section).classList.remove('hidden');
    },

    generateTasks: function(k, field) {
        const age = parseInt(k.age) || 8;
        const dow = new Date().getDay();
        const d = DAYS[(dow+6)%7];
        const sch = k.schedule[d];
        const free = this.calcFree(sch.sStart, sch.sEnd, sch.hStart, sch.hEnd);
        
        const pool = [
            "Zimmer aufr√§umen", "Bett machen", "Hausaufgaben erledigen", "Tisch decken",
            "Geschirr abr√§umen", "M√ºll rausbringen", "Pflanzen gie√üen", "Haustier f√ºttern",
            "10 Minuten lesen", "Schuhe putzen", "Spielzeug sortieren", "Brief an Oma schreiben"
        ];
        
        let n = Math.max(2, Math.min(6, Math.floor(free/2)));
        if(age<10) n = Math.min(n,4);
        
        const sel = pool.sort(()=>Math.random()-0.5).slice(0,n);
        k[field] = sel.map((t,i)=>({id:Date.now()+i, text:t, done:false}));
    },

    getFreeTime: function(k) {
        const dow = new Date().getDay();
        const d = DAYS[(dow+6)%7];
        const s = k.schedule[d];
        return this.calcFree(s.sStart, s.sEnd, s.hStart, s.hEnd);
    },

    calcFree: function(ss, se, hs, he) {
        const toMin = t => {
            if(!t) return 0;
            const [h,m] = t.split(':').map(Number);
            return h*60+m;
        };
        const school = toMin(se) - toMin(ss);
        const hobby = (hs&&he) ? (toMin(he)-toMin(hs)) : 0;
        const wake = 14*60;
        return Math.max(0, (wake - school - hobby)/60);
    },

    childToggle: function(tid) {
        const k = this.data.kids[this.user];
        if(k.lastFinished === new Date().toDateString()) return;
        const t = k.tasksToday.find(x => x.id === tid);
        if(t) { t.done = !t.done; this.save(); this.renderChild(this.user); }
    },

    finishDay: function() {
        if(!confirm("üéâ Tag wirklich abschlie√üen?")) return;
        const k = this.data.kids[this.user];
        const done = k.tasksToday.filter(t=>t.done).length;
        const total = k.tasksToday.length || 1;
        const earn = (k.allowance/30)*(done/total);
        k.balance += earn;
        k.lastFinished = new Date().toDateString();
        this.save();
        alert(`üéä Gut gemacht! Du hast ${earn.toFixed(2)}‚Ç¨ verdient!`);
        this.renderChild(this.user);
    },

    saveHobbies: function() {
        const k = this.data.kids[this.user];
        DAYS.forEach(d => {
            k.schedule[d].hName = document.getElementById(`h-n-${d}`).value;
            k.schedule[d].hStart = document.getElementById(`h-s-${d}`).value;
            k.schedule[d].hEnd = document.getElementById(`h-e-${d}`).value;
        });
        this.save(); 
        alert("‚úÖ Wochenplan gespeichert!");
    },

    saveProfileData: function() {
        const k = this.data.kids[this.user];
        k.nick = document.getElementById('p-nick').value;
        if(document.getElementById('p-pass').value) {
            k.pass = document.getElementById('p-pass').value;
        }
        this.save(); 
        alert("‚úÖ Profil wurde gespeichert!");
    },

    sendMsg: function() {
        const t = document.getElementById('msg-text').value;
        if(t) {
            const k = this.data.kids[this.user];
            this.data.msgs.push({
                from: k.nick || k.name, 
                text: t, 
                date: new Date().toLocaleString()
            });
            this.save(); 
            document.getElementById('msg-text').value=""; 
            alert("‚úÖ Nachricht wurde gesendet!");
        }
    },

    renderParent: function() {
        this.hideAll();
        document.getElementById('view-parent').classList.remove('hidden');
        
        const inbox = document.getElementById('parent-inbox');
        inbox.innerHTML = this.data.msgs.length ? "" : "<div class='info-box'>Keine Nachrichten vorhanden.</div>";
        this.data.msgs.forEach((m,i)=> {
            inbox.innerHTML += `<div style="background:rgba(245,158,11,0.1); padding:16px; margin-bottom:10px; border-radius:var(--radius-sm); border-left:4px solid var(--warning); box-shadow:var(--shadow-sm);">
                <strong>${m.from}:</strong> ${m.text}
                <div style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">${m.date}</div>
                <button class="del-btn" onclick="app.delMsg(${i})" style="margin-top:8px;">üóëÔ∏è L√∂schen</button>
            </div>`;
        });

        const grid = document.getElementById('parent-grid');
        grid.innerHTML = "";
        this.data.kids.forEach((k,i)=>{
            if(!k.name) return;
            let tasks = k.tasksToday.map(t=>
                `<div style="display:flex; justify-content:space-between; align-items:center; padding:8px; margin:4px 0; background:var(--bg-color); border-radius:var(--radius-sm);">
                    <span>${t.done?'‚úÖ':'‚¨ú'} ${t.text}</span>
                    <button class="del-btn" onclick="app.pDelTask(${i},${t.id})">üóëÔ∏è</button>
                </div>`
            ).join('');
            
            grid.innerHTML += `<div class="card">
                <h3>${k.name}</h3>
                <div class="stat-card" style="margin:15px 0;">
                    <div class="stat-value">${k.balance.toFixed(2)}‚Ç¨</div>
                    <div class="stat-label">Guthaben</div>
                </div>
                <div style="margin-top:15px; padding-top:15px; border-top:1px solid var(--border);">
                    <h4 style="margin-bottom:10px; font-size:0.95rem;">Heutige Aufgaben</h4>
                    ${tasks || '<div class="info-box">Keine Aufgaben</div>'}
                </div>
                <button class="secondary" onclick="app.pAddTask(${i})" style="margin-top:10px;">‚ûï Aufgabe hinzuf√ºgen</button>
            </div>`;
        });
    },

    pAddTask: function(ki) { 
        const t = prompt("Neue Aufgabe:"); 
        if(t){
            this.data.kids[ki].tasksToday.push({
                id: Date.now(),
                text: t,
                done: false
            });
            this.save();
            this.renderParent();
        } 
    },

    pDelTask: function(ki,ti) { 
        this.data.kids[ki].tasksToday = this.data.kids[ki].tasksToday.filter(x=>x.id!==ti);
        this.save();
        this.renderParent(); 
    },

    delMsg: function(i) { 
        this.data.msgs.splice(i,1); 
        this.save(); 
        this.renderParent(); 
    },

    exportData: function() { 
        const a = document.createElement("a"); 
        a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.data)); 
        a.download = "schnitzler-backup-" + new Date().toISOString().split('T')[0] + ".json"; 
        a.click(); 
        alert("‚úÖ Backup wurde heruntergeladen!");
    }
};

window.onload = () => app.init();
</script>
</body>
</html>
