<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Familie Schnitzler - Live Sync</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #6366f1;
            --bg-color: #f8fafc;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --paper: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            --radius: 16px;
            --radius-sm: 8px;
        }

        body.dark-mode {
            --bg-color: #0f172a;
            --bg-gradient: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            --paper: #1e293b;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text);
            padding-bottom: 100px;
            min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* SYNC INDICATOR */
        #sync-status {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--paper);
            padding: 10px 16px;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            border: 2px solid var(--border);
        }

        #sync-status.syncing { border-color: var(--warning); }
        #sync-status.synced { border-color: var(--success); }
        #sync-status.error { border-color: var(--danger); }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        #sync-status.syncing .sync-dot {
            background: var(--warning);
            animation: pulse 1s infinite;
        }

        #sync-status.synced .sync-dot {
            background: var(--success);
        }

        #sync-status.error .sync-dot {
            background: var(--danger);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        header { 
            background: var(--bg-gradient);
            color: white;
            padding: 20px;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 { font-size: 1.5rem; margin: 0; }

        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .card {
            background: var(--paper);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .hidden { display: none !important; }

        h2, h3 { margin-top: 0; color: var(--text); }
        h2 { font-size: 1.75rem; margin-bottom: 8px; }
        h3 { font-size: 1.25rem; margin-bottom: 16px; }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9em;
            color: var(--text-muted);
        }

        input, select, textarea {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            width: 100%;
            background: var(--bg-color);
            color: var(--text);
            font-size: 16px;
            margin-bottom: 12px;
            outline: none;
            transition: all 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            background: var(--paper);
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
            font-weight: 600;
            margin-top: 8px;
            transition: all 0.2s ease;
        }

        button:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        button.secondary {
            background: var(--text-muted);
            width: auto;
            padding: 10px 20px;
            font-size: 0.9rem;
            margin: 5px 5px 5px 0;
            display: inline-block;
        }

        button.del-btn {
            background: var(--danger);
            width: auto;
            padding: 6px 12px;
            font-size: 0.85rem;
            margin: 0;
        }

        .tabs {
            display: flex;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--paper);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            z-index: 90;
            border-top: 1px solid var(--border);
        }

        .tab-btn {
            background: transparent;
            color: var(--text-muted);
            border: none;
            padding: 12px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.7rem;
            opacity: 0.7;
            flex: 1;
            border-radius: 0;
            margin: 0;
            position: relative;
        }

        .tab-btn span {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .tab-btn.active {
            color: var(--primary);
            opacity: 1;
            font-weight: 700;
        }

        .tab-btn.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
        }

        .info-box {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.1) 0%, rgba(99, 102, 241, 0.05) 100%);
            border-left: 4px solid var(--primary);
            padding: 16px;
            border-radius: var(--radius-sm);
            margin: 16px 0;
            font-size: 0.9rem;
        }

        .warning-box {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(251, 191, 36, 0.05) 100%);
            border-left: 4px solid var(--warning);
            padding: 16px;
            border-radius: var(--radius-sm);
            margin: 16px 0;
            font-size: 0.9rem;
        }

        .success-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(52, 211, 153, 0.05) 100%);
            border-left: 4px solid var(--success);
            padding: 16px;
            border-radius: var(--radius-sm);
            margin: 16px 0;
            font-size: 0.9rem;
        }

        .login-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }

        .user-card {
            background: var(--paper);
            border: 2px solid var(--border);
            padding: 20px;
            text-align: center;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .user-avatar-img {
            width: 75px;
            height: 75px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 12px;
            border: 3px solid var(--primary);
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: var(--radius-sm);
            margin-bottom: 4px;
        }

        .task-item:hover { background: var(--bg-color); }
        .task-item.done { opacity: 0.5; text-decoration: line-through; }

        .checkbox {
            width: 28px;
            height: 28px;
            border: 2.5px solid var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .checkbox.checked {
            background: var(--success);
            border-color: var(--success);
        }

        .stat-card {
            background: var(--bg-color);
            border-radius: var(--radius-sm);
            padding: 16px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: 50px 1fr 1fr;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            border-radius: var(--radius-sm);
        }

        .schedule-grid label {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .schedule-grid input {
            margin: 0;
            padding: 10px;
            font-size: 0.9rem;
        }

        .weekend-row {
            background: rgba(245, 158, 11, 0.1);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--warning);
        }

        .plan-row {
            padding: 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }

        .plan-inputs {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 8px;
        }

        .plan-inputs input { margin: 0; }

        #setup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
        }

        #setup-modal .modal-content {
            background: var(--paper);
            border-radius: var(--radius);
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        code {
            background: var(--bg-color);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

<div id="setup-modal" class="hidden">
    <div class="modal-content">
        <h2>üöÄ Supabase Einrichtung</h2>
        
        <div class="warning-box">
            <strong>‚ö†Ô∏è Einmalige Einrichtung erforderlich</strong><br>
            Die App ben√∂tigt eine Supabase-Datenbank f√ºr die Synchronisation.
        </div>

        <div class="info-box">
            <strong>üìù Schritt-f√ºr-Schritt Anleitung:</strong><br><br>
            
            <strong>1. Supabase Account erstellen</strong><br>
            ‚Üí Gehe zu: <a href="https://supabase.com" target="_blank">supabase.com</a><br>
            ‚Üí Klicke "Start your project" (kostenlos!)<br>
            ‚Üí Mit GitHub/Google anmelden<br><br>

            <strong>2. Neues Projekt erstellen</strong><br>
            ‚Üí "New Project" klicken<br>
            ‚Üí Name: <code>schnitzler-family</code><br>
            ‚Üí Database Password: [Merken!]<br>
            ‚Üí Region: Europe (Frankfurt)<br>
            ‚Üí "Create new project" klicken<br>
            ‚Üí Warte ~2 Minuten<br><br>

            <strong>3. Tabelle erstellen</strong><br>
            ‚Üí Linke Sidebar ‚Üí "Table Editor"<br>
            ‚Üí "Create a new table"<br>
            ‚Üí Name: <code>family_data</code><br>
            ‚Üí Columns hinzuf√ºgen:<br>
            &nbsp;&nbsp;‚Ä¢ <code>id</code> (int8, primary key) - bereits da<br>
            &nbsp;&nbsp;‚Ä¢ <code>family_id</code> (text) - "Add column"<br>
            &nbsp;&nbsp;‚Ä¢ <code>data</code> (jsonb) - "Add column"<br>
            &nbsp;&nbsp;‚Ä¢ <code>updated_at</code> (timestamptz) - "Add column"<br>
            ‚Üí "Save" klicken<br><br>

            <strong>4. API-Schl√ºssel kopieren</strong><br>
            ‚Üí Linke Sidebar ‚Üí "Settings" (Zahnrad-Symbol)<br>
            ‚Üí "API"<br>
            ‚Üí Kopiere:<br>
            &nbsp;&nbsp;‚Ä¢ Project URL<br>
            &nbsp;&nbsp;‚Ä¢ anon public (API Key)<br><br>

            <strong>5. Hier einf√ºgen:</strong>
        </div>

        <label>Supabase URL:</label>
        <input type="text" id="supabase-url" placeholder="https://xxx.supabase.co">

        <label>Supabase Key (anon public):</label>
        <input type="text" id="supabase-key" placeholder="eyJhbGci...">

        <label>Familien-ID (frei w√§hlbar):</label>
        <input type="text" id="family-id" placeholder="z.B. schnitzler2025" value="family1">
        <small style="color: var(--text-muted);">Alle mit der gleichen ID sehen die gleichen Daten</small>

        <button onclick="app.saveSupabaseConfig()">üíæ Konfiguration speichern</button>
        <button class="secondary" onclick="alert('Supabase ist erforderlich f√ºr die Synchronisation.\n\nOhne Supabase funktioniert die App nur lokal.')">‚ùå Abbrechen</button>

        <div class="warning-box" style="margin-top: 20px;">
            <strong>üí° Tipp:</strong> Die Einrichtung dauert nur 5-10 Minuten und muss nur EINMAL gemacht werden.
            Danach k√∂nnen alle Familienmitglieder die App nutzen!
        </div>
    </div>
</div>

<div id="sync-status" class="error">
    <div class="sync-dot"></div>
    <span id="sync-text">Nicht konfiguriert</span>
</div>

<header>
    <h1>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Schnitzler Family App</h1>
</header>

<div id="view-login" class="container">
    <div class="card">
        <h2 style="text-align:center">üëã Wer bist du?</h2>
        <p style="text-align:center; color:var(--text-muted); margin-bottom:20px;">W√§hle dein Profil aus</p>
        <div class="login-grid" id="login-users"></div>
        <div style="margin-top:30px; text-align:center;">
            <button class="secondary" onclick="app.checkPinAndSetup()">‚öôÔ∏è Admin-Einstellungen</button>
        </div>
    </div>
</div>

<div id="view-setup" class="container hidden">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0;">‚öôÔ∏è Administrator</h2>
            <button class="secondary" style="margin:0;" onclick="app.showLogin()">üö™ Abmelden</button>
        </div>

        <div class="success-box">
            <strong>‚úÖ Live-Synchronisation aktiv!</strong><br>
            Alle √Ñnderungen werden automatisch mit allen Ger√§ten synchronisiert.
        </div>

        <div style="margin:20px 0; padding-bottom:20px; border-bottom:2px dashed var(--border);">
            <h3>‚òÅÔ∏è Supabase Konfiguration</h3>
            <button class="secondary" onclick="app.showSupabaseSetup()">‚öôÔ∏è Supabase neu konfigurieren</button>
            <button class="secondary" onclick="app.testConnection()">üîç Verbindung testen</button>
        </div>

        <div style="margin:20px 0; padding-bottom:20px; border-bottom:2px dashed var(--border);">
            <h3>üîë Sicherheit</h3>
            <button class="secondary" onclick="app.changePin()">üîë Admin-PIN √§ndern</button>
        </div>

        <div style="margin:20px 0; padding-bottom:20px; border-bottom:2px dashed var(--border);">
            <h3>üé® Farbschema</h3>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <div style="width: 45px; height: 45px; border-radius: 50%; background: #e67e22; cursor: pointer;" onclick="app.setColor('#e67e22')"></div>
                <div style="width: 45px; height: 45px; border-radius: 50%; background: #3498db; cursor: pointer;" onclick="app.setColor('#3498db')"></div>
                <div style="width: 45px; height: 45px; border-radius: 50%; background: #9b59b6; cursor: pointer;" onclick="app.setColor('#9b59b6')"></div>
                <div style="width: 45px; height: 45px; border-radius: 50%; background: #e74c3c; cursor: pointer;" onclick="app.setColor('#e74c3c')"></div>
                <div style="width: 45px; height: 45px; border-radius: 50%; background: #1abc9c; cursor: pointer;" onclick="app.setColor('#1abc9c')"></div>
            </div>
        </div>

        <div id="setup-kids"></div>
        <button onclick="app.saveSetup()">üíæ Konfiguration speichern</button>
    </div>
</div>

<div id="view-child" class="container hidden">
    <div class="card">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:20px;">
            <img id="c-avatar" style="width:60px; height:60px; border-radius:50%; border:3px solid var(--primary);" src="https://cdn-icons-png.flaticon.com/512/847/847969.png">
            <div style="flex:1;">
                <h2 id="c-name" style="margin:0;">Kind</h2>
                <p id="c-free" style="color:var(--text-muted); margin:0; font-size:0.9rem;"></p>
            </div>
            <button class="secondary" onclick="app.showLogin()">üö™</button>
        </div>
    </div>

    <div id="child-tasks" class="hidden">
        <div class="card">
            <h3>‚úÖ Deine Aufgaben heute</h3>
            <div id="c-task-list"></div>
            <button id="finish-btn" onclick="app.finishDay()" style="margin-top:15px;">üéâ Tag abschlie√üen</button>
            <div id="preview-box" class="hidden info-box" style="margin-top:15px;">
                <h4 style="margin-top:0; color:var(--primary);">üìã Morgen wartet auf dich:</h4>
                <ul id="preview-list" style="margin:0; padding-left:20px;"></ul>
            </div>
        </div>
    </div>

    <div id="child-finance" class="hidden">
        <div class="card">
            <h3>üí∞ Dein Guthaben</h3>
            <div class="stat-card" style="margin:20px 0;">
                <div class="stat-value" id="c-bal">0.00 ‚Ç¨</div>
                <div class="stat-label">Aktuelles Guthaben</div>
            </div>
            <div class="info-box">
                <p id="c-proj" style="margin:0; font-weight:600;"></p>
            </div>
        </div>
    </div>

    <div id="child-plan" class="hidden">
        <div class="card">
            <h3>üìÖ Wochenplan</h3>
            <p style="color:var(--text-muted); margin-bottom:20px;">Trage deine Termine und Hobbys ein</p>
            <div id="hobby-container"></div>
            <button onclick="app.saveHobbies()" style="margin-top:15px;">üíæ Plan speichern</button>
        </div>
    </div>

    <div id="child-profile" class="hidden">
        <div class="card">
            <h3>üë§ Profil-Einstellungen</h3>
            <label>Spitzname</label>
            <input id="p-nick" placeholder="Dein Spitzname">
            <label style="margin-top:15px;">Passwort (optional)</label>
            <input type="password" id="p-pass" placeholder="Neues Passwort">
            <button onclick="app.saveProfileData()" style="margin-top:15px;">üíæ Profil speichern</button>
        </div>
    </div>

    <div id="child-msg" class="hidden">
        <div class="card">
            <h3>üí¨ Nachricht an Eltern</h3>
            <textarea id="msg-text" rows="4" placeholder="Deine Nachricht..."></textarea>
            <button onclick="app.sendMsg()">üì§ Nachricht senden</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="app.nav('tasks',this)"><span>‚úÖ</span>Aufgaben</button>
        <button class="tab-btn" onclick="app.nav('finance',this)"><span>üí∞</span>Guthaben</button>
        <button class="tab-btn" onclick="app.nav('plan',this)"><span>üìÖ</span>Plan</button>
        <button class="tab-btn" onclick="app.nav('profile',this)"><span>üë§</span>Profil</button>
        <button class="tab-btn" onclick="app.nav('msg',this)"><span>üí¨</span>Nachricht</button>
    </div>
</div>

<div id="view-parent" class="container hidden">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Eltern-√úbersicht</h2>
            <button class="secondary" style="margin:0;" onclick="app.showLogin()">üö™ Abmelden</button>
        </div>
        
        <h3>üì¨ Nachrichten von Kindern</h3>
        <div id="parent-inbox" style="margin-bottom:30px;"></div>
        
        <h3 style="margin-top:30px;">üë∂ Kinder-Status</h3>
        <div id="parent-grid"></div>
    </div>
</div>

<!-- Supabase Client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const DAYS = ["Mo","Di","Mi","Do","Fr","Sa","So"];
const DEFAULT = {
    pin: "1234",
    color: "#4f46e5",
    darkMode: false,
    kids: [],
    msgs: [],
    lastModified: Date.now()
};

const app = {
    data: null,
    user: null,
    supabase: null,
    familyId: null,
    syncInterval: null,

    init: async function() {
        // Load Supabase config
        const config = localStorage.getItem('supabaseConfig');
        
        if(!config) {
            this.showSupabaseSetup();
            return;
        }

        const { url, key, familyId } = JSON.parse(config);
        this.familyId = familyId;
        
        // Initialize Supabase
        this.supabase = supabase.createClient(url, key);
        
        // Load data
        await this.loadFromSupabase();
        
        // Start auto-sync
        this.startAutoSync();
        
        this.showLogin();
    },

    showSupabaseSetup: function() {
        document.getElementById('setup-modal').classList.remove('hidden');
    },

    saveSupabaseConfig: function() {
        const url = document.getElementById('supabase-url').value.trim();
        const key = document.getElementById('supabase-key').value.trim();
        const familyId = document.getElementById('family-id').value.trim();

        if(!url || !key || !familyId) {
            alert('‚ùå Bitte alle Felder ausf√ºllen!');
            return;
        }

        if(!url.includes('supabase.co')) {
            alert('‚ùå Ung√ºltige Supabase URL!');
            return;
        }

        const config = { url, key, familyId };
        localStorage.setItem('supabaseConfig', JSON.stringify(config));
        
        alert('‚úÖ Konfiguration gespeichert!\n\nSeite wird neu geladen...');
        location.reload();
    },

    async loadFromSupabase() {
        this.setSyncStatus('syncing', 'Lade Daten...');
        
        try {
            const { data, error } = await this.supabase
                .from('family_data')
                .select('data')
                .eq('family_id', this.familyId)
                .single();

            if(error && error.code !== 'PGRST116') {
                throw error;
            }

            if(data) {
                this.data = data.data;
            } else {
                // First time - create default
                this.data = JSON.parse(JSON.stringify(DEFAULT));
                await this.saveToSupabase();
            }

            this.setSyncStatus('synced', 'Synchronisiert');
        } catch(error) {
            console.error('Load error:', error);
            this.setSyncStatus('error', 'Ladefehler');
            this.data = JSON.parse(JSON.stringify(DEFAULT));
        }
    },

    async saveToSupabase() {
        this.setSyncStatus('syncing', 'Speichere...');
        this.data.lastModified = Date.now();

        try {
            const { error } = await this.supabase
                .from('family_data')
                .upsert({
                    family_id: this.familyId,
                    data: this.data,
                    updated_at: new Date().toISOString()
                }, {
                    onConflict: 'family_id'
                });

            if(error) throw error;

            this.setSyncStatus('synced', 'Synchronisiert');
        } catch(error) {
            console.error('Save error:', error);
            this.setSyncStatus('error', 'Speicherfehler');
        }
    },

    startAutoSync: function() {
        // Check for updates every 5 seconds
        this.syncInterval = setInterval(async () => {
            await this.loadFromSupabase();
        }, 5000);
    },

    async testConnection() {
        this.setSyncStatus('syncing', 'Teste...');
        
        try {
            const { data, error } = await this.supabase
                .from('family_data')
                .select('family_id')
                .limit(1);

            if(error) throw error;

            alert('‚úÖ Verbindung erfolgreich!\n\nSupabase ist korrekt konfiguriert.');
            this.setSyncStatus('synced', 'Verbunden');
        } catch(error) {
            alert('‚ùå Verbindungsfehler!\n\n' + error.message);
            this.setSyncStatus('error', 'Fehler');
        }
    },

    setSyncStatus: function(status, text) {
        const el = document.getElementById('sync-status');
        el.className = status;
        document.getElementById('sync-text').textContent = text;
    },

    save: async function() {
        await this.saveToSupabase();
    },

    setColor: function(col) {
        this.data.color = col;
        document.documentElement.style.setProperty('--primary', col);
        this.save();
    },

    hideAll: function() {
        document.querySelectorAll('.container').forEach(v=>v.classList.add('hidden'));
    },

    showLogin: function() {
        this.hideAll();
        document.getElementById('view-login').classList.remove('hidden');
        const grid = document.getElementById('login-users');
        grid.innerHTML = "";
        
        this.data.kids.forEach((k,i) => {
            if(!k.name) return;
            const av = k.avatar || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
            grid.innerHTML += `<div class="user-card" onclick="app.tryLogin(${i},false)">
                <img class="user-avatar-img" src="${av}"><br><b>${k.nick||k.name}</b>
            </div>`;
        });
        
        grid.innerHTML += `<div class="user-card" onclick="app.tryLogin(-1,true)">
            <img class="user-avatar-img" src="https://cdn-icons-png.flaticon.com/512/747/747376.png"><br><b>Eltern</b>
        </div>`;
    },

    tryLogin: function(idx, isParent) {
        const k = this.data.kids[idx];
        if(!isParent && k && k.pass) {
            const p = prompt("Passwort:");
            if(p !== k.pass) { alert("Falsches Passwort!"); return; }
        }
        if(isParent) {
            const p = prompt("Eltern-PIN:");
            if(p !== this.data.pin) { alert("Falsche PIN!"); return; }
            this.renderParent();
        } else {
            this.user = idx;
            this.renderChild(idx);
        }
    },

    checkPinAndSetup: function() {
        const p = prompt("Admin-PIN:");
        if(p !== this.data.pin) { alert("Falsche PIN!"); return; }
        this.renderSetup();
    },

    renderSetup: function() {
        this.hideAll();
        document.getElementById('view-setup').classList.remove('hidden');
        
        const cnt = document.getElementById('setup-kids');
        cnt.innerHTML = "";
        
        for(let i=0; i<4; i++) {
            if(!this.data.kids[i]) {
                this.data.kids[i] = {
                    name:"", age:"", allowance:0, balance:0, avatar:"", pass:"", nick:"",
                    tasksToday:[], tasksTomorrow:[], lastFinished:"",
                    schedule: {}
                };
                DAYS.forEach(d => this.data.kids[i].schedule[d] = {sStart:"08:00",sEnd:"16:00",hName:"",hStart:"",hEnd:""});
            }
            const k = this.data.kids[i];
            
            cnt.innerHTML += `
            <div class="card" style="margin-bottom:20px;">
                <h3>üë∂ Kind ${i+1}</h3>
                <label>Name</label>
                <input id="n-${i}" value="${k.name||''}" placeholder="Name des Kindes">
                <label>Alter</label>
                <input id="a-${i}" value="${k.age||''}" placeholder="z.B. 8">
                <label>Taschengeld pro Monat (‚Ç¨)</label>
                <input type="number" step="0.01" id="m-${i}" value="${k.allowance||0}">
                
                <h4 style="margin-top:20px;">üìö Schulzeiten (Mo-So)</h4>
                <div id="schedule-${i}"></div>
            </div>`;
        }
        
        this.data.kids.forEach((k,i) => {
            const sch = document.getElementById(`schedule-${i}`);
            DAYS.forEach(d => {
                const s = k.schedule[d];
                const isWE = (d==="Sa"||d==="So");
                sch.innerHTML += `<div class="schedule-grid ${isWE?'weekend-row':''}">
                    <label style="font-weight:${isWE?'700':'600'}">${d}</label>
                    <input type="time" id="ss-${i}-${d}" value="${s.sStart}">
                    <input type="time" id="se-${i}-${d}" value="${s.sEnd}">
                </div>`;
            });
        });
    },

    saveSetup: function() {
        this.data.kids.forEach((k,i)=>{
            k.name = document.getElementById(`n-${i}`).value;
            k.age = document.getElementById(`a-${i}`).value;
            k.allowance = parseFloat(document.getElementById(`m-${i}`).value)||0;
            
            DAYS.forEach(d => {
                k.schedule[d].sStart = document.getElementById(`ss-${i}-${d}`).value;
                k.schedule[d].sEnd = document.getElementById(`se-${i}-${d}`).value;
            });
        });
        this.save();
        alert("‚úÖ Konfiguration gespeichert und synchronisiert!");
        this.showLogin();
    },

    changePin: function() {
        const p = prompt("Neuer Admin-PIN:");
        if(p) {
            this.data.pin = p;
            this.save();
            alert("‚úÖ PIN ge√§ndert!");
        }
    },

    renderChild: function(idx) {
        this.hideAll();
        document.getElementById('view-child').classList.remove('hidden');
        this.nav('tasks', document.querySelectorAll('.tab-btn')[0]);
        
        const k = this.data.kids[idx];
        document.getElementById('c-name').innerText = k.nick || k.name || `Kind ${idx+1}`;
        document.getElementById('c-avatar').src = k.avatar || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
        document.getElementById('c-free').innerText = `üí∞ Guthaben: ${k.balance.toFixed(2)} ‚Ç¨`;

        const list = document.getElementById('c-task-list');
        list.innerHTML = "";
        
        if(!k.tasksToday.length) {
            this.generateTasks(k, 'tasksToday');
            this.save();
        }
        
        k.tasksToday.forEach(t => {
            list.innerHTML += `<div class="task-item ${t.done?'done':''}" onclick="app.childToggle(${t.id})">
                <div class="checkbox ${t.done?'checked':''}">${t.done?'‚úì':''}</div><span>${t.text}</span>
            </div>`;
        });
        
        const isDone = k.lastFinished === new Date().toDateString();
        document.getElementById('finish-btn').style.display = isDone ? 'none' : 'block';
        
        if(isDone) {
            document.getElementById('preview-box').classList.remove('hidden');
            if(!k.tasksTomorrow.length) { this.generateTasks(k, 'tasksTomorrow'); this.save(); }
            document.getElementById('preview-list').innerHTML = k.tasksTomorrow.map(t=>`<li>${t.text}</li>`).join('');
        } else {
            document.getElementById('preview-box').classList.add('hidden');
        }

        document.getElementById('c-bal').innerText = k.balance.toFixed(2)+" ‚Ç¨";
        document.getElementById('c-proj').innerText = "üìä W√∂chentlich: " + ((k.allowance/30)*7).toFixed(2) + " ‚Ç¨";
        document.getElementById('p-nick').value = k.nick || k.name;
    },

    nav: function(section, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        ['tasks','finance','plan','profile','msg'].forEach(s => {
            document.getElementById('child-'+s).classList.add('hidden');
        });
        document.getElementById('child-'+section).classList.remove('hidden');
    },

    generateTasks: function(k, field) {
        const pool = [
            "Zimmer aufr√§umen", "Bett machen", "Hausaufgaben", "Tisch decken",
            "Geschirr abr√§umen", "M√ºll rausbringen", "10 Minuten lesen"
        ];
        const n = 4;
        const sel = pool.sort(()=>Math.random()-0.5).slice(0,n);
        k[field] = sel.map((t,i)=>({id:Date.now()+i, text:t, done:false}));
    },

    childToggle: function(tid) {
        const k = this.data.kids[this.user];
        if(k.lastFinished === new Date().toDateString()) return;
        const t = k.tasksToday.find(x => x.id === tid);
        if(t) { t.done = !t.done; this.save(); this.renderChild(this.user); }
    },

    finishDay: function() {
        if(!confirm("üéâ Tag abschlie√üen?")) return;
        const k = this.data.kids[this.user];
        const done = k.tasksToday.filter(t=>t.done).length;
        const total = k.tasksToday.length || 1;
        const earn = (k.allowance/30)*(done/total);
        k.balance += earn;
        k.lastFinished = new Date().toDateString();
        this.save();
        alert(`üéä Super! Du hast ${earn.toFixed(2)}‚Ç¨ verdient!`);
        this.renderChild(this.user);
    },

    saveHobbies: function() {
        const k = this.data.kids[this.user];
        DAYS.forEach(d => {
            k.schedule[d].hName = document.getElementById(`h-n-${d}`).value;
            k.schedule[d].hStart = document.getElementById(`h-s-${d}`).value;
            k.schedule[d].hEnd = document.getElementById(`h-e-${d}`).value;
        });
        this.save();
        alert("‚úÖ Wochenplan gespeichert!");
    },

    saveProfileData: function() {
        const k = this.data.kids[this.user];
        k.nick = document.getElementById('p-nick').value;
        if(document.getElementById('p-pass').value) {
            k.pass = document.getElementById('p-pass').value;
        }
        this.save();
        alert("‚úÖ Profil gespeichert!");
    },

    sendMsg: function() {
        const t = document.getElementById('msg-text').value;
        if(t) {
            const k = this.data.kids[this.user];
            this.data.msgs.push({
                from: k.nick || k.name,
                text: t,
                date: new Date().toLocaleString()
            });
            this.save();
            document.getElementById('msg-text').value = "";
            alert("‚úÖ Nachricht gesendet!");
        }
    },

    renderParent: function() {
        this.hideAll();
        document.getElementById('view-parent').classList.remove('hidden');
        
        const inbox = document.getElementById('parent-inbox');
        inbox.innerHTML = this.data.msgs.length ? "" : "<div class='info-box'>Keine Nachrichten</div>";
        this.data.msgs.forEach((m,i)=> {
            inbox.innerHTML += `<div class="warning-box">
                <strong>${m.from}:</strong> ${m.text}
                <div style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">${m.date}</div>
                <button class="del-btn" onclick="app.delMsg(${i})" style="margin-top:8px;">üóëÔ∏è</button>
            </div>`;
        });

        const grid = document.getElementById('parent-grid');
        grid.innerHTML = "";
        this.data.kids.forEach((k,i)=>{
            if(!k.name) return;
            let tasks = k.tasksToday.map(t=>
                `<div style="padding:8px; margin:4px 0; background:var(--bg-color); border-radius:8px;">
                    ${t.done?'‚úÖ':'‚¨ú'} ${t.text}
                </div>`
            ).join('');
            
            grid.innerHTML += `<div class="card">
                <h3>${k.name}</h3>
                <div class="stat-card" style="margin:15px 0;">
                    <div class="stat-value">${k.balance.toFixed(2)}‚Ç¨</div>
                    <div class="stat-label">Guthaben</div>
                </div>
                <div style="margin-top:15px; padding-top:15px; border-top:1px solid var(--border);">
                    <h4 style="margin-bottom:10px; font-size:0.95rem;">Aufgaben</h4>
                    ${tasks || '<div class="info-box">Keine Aufgaben</div>'}
                </div>
            </div>`;
        });
    },

    delMsg: function(i) {
        this.data.msgs.splice(i,1);
        this.save();
        this.renderParent();
    }
};

window.onload = () => app.init();
</script>
</body>
</html>
